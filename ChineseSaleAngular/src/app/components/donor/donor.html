<h2 class="page-title">תורמים</h2>

<nz-input-group [nzPrefix]="prefixIconSearch" style="margin-bottom: 20px;">
  <input 
    type="text" 
    nz-input 
    placeholder="חפש תורם..." 
    [(ngModel)]="searchText"
    (ngModelChange)="onSearchChange($event)"
  />
</nz-input-group>
<ng-template #prefixIconSearch>
  <span nz-icon nzType="search"></span>
</ng-template>

<nz-modal [(nzVisible)]="addModalVisible" [nzTitle]="'הוספת תורם להגרלה'" [nzFooter]="null"
    (nzOnCancel)="closeAddModal()">
    <ng-container *nzModalContent>
        <nz-card nzTitle="הוספת תורם קיים" nzBordered="false">
            <div class="donor-select">
                <label>בחר תורם קיים</label>
                <nz-select nzShowSearch nzPlaceHolder="בחר תורם" [(ngModel)]="selectedDonorId">
                    @for (donor of allDonorsForAdd; track donor.id) {
                    <nz-option [nzValue]="donor.id"
                        [nzLabel]="(donor.firstName || '') + ' ' + (donor.lastName || '') + ' - ' + donor.companyName"></nz-option>
                    }
                </nz-select>
            </div>
            <div class="modal-actions">
                <button nz-button (click)="closeAddModal()">סגור</button>
                <button nz-button nzType="primary" [disabled]="!selectedDonorId"
                    (click)="confirmAddDonor()">אישור</button>
            </div>
        </nz-card>
        <nz-card nzTitle="הוספת תורם חדש" nzBordered="false">
            <button nz-button nzType="default" (click)="goToAddDonor()">הוסף תורם חדש</button>
        </nz-card>
    </ng-container>
</nz-modal>

<div class="donors-grid">
    <div class="page-description">
        רשימת התורמים להגרלה
    </div>
    
    @for (donor of allDonors; track donor.id) {
    <nz-card style="width:100%;" [nzCover]="coverTemplate" [nzActions]="[editAction, deleteAction]">
        <a [routerLink]="['/donors', donor.id]">
            <nz-card-meta 
                [nzTitle]="donor.firstName + ' ' + donor.lastName" 
                [nzDescription]="donor.companyName">
            </nz-card-meta>
            <div class="donor-details">
                @if(donor.companyEmail) {
                <div><strong>אימייל:</strong> {{donor.companyEmail}}</div>
                }
                @if(donor.companyPhone) {
                <div><strong>טלפון:</strong> {{donor.companyPhone}}</div>
                }
            </div>
        </a>
    </nz-card>

    <ng-template #coverTemplate>
        @if(donor.companyIcon) {
        <img alt="{{donor.companyName}}" src="{{donor.companyIcon}}" />
        }
        @else {
        <div class="donor-placeholder">
            <span nz-icon nzType="user" nzTheme="outline"></span>
        </div>
        }
    </ng-template>

    <ng-template #editAction>
        <span nz-icon nzType="edit" nzTheme="outline" (click)="edit(donor)"></span>
    </ng-template>

    <ng-template #deleteAction>
        <span nz-icon nzType="delete" nzTheme="outline" (click)="delete(donor.id)"></span>
    </ng-template>
    }

    @if (filteredDonors.length === 0) {
    <div class="empty-message">לא נמצאו תורמים</div>
    }
</div>

<nz-pagination class="nz-pagination" [nzPageIndex]="pageNumber" [nzTotal]="data?.totalCount || 0"
    [nzPageSize]="pageSize" (nzPageIndexChange)="onPageChange($event)" nzSimple />

<button class="add-donor-button" nz-button nzType="primary" (click)="add()">
    <span nz-icon nzType="user-add" nzTheme="outline"></span>
    <span>הוסף תורם</span>
</button>

<router-outlet></router-outlet>